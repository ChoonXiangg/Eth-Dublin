<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Comprehensive Passport Verification Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: white;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            transition: background 0.3s ease;
        }

        .status-indicator.connected {
            background: #51cf66;
        }

        .button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .button:disabled {
            background: linear-gradient(45deg, #9e9e9e, #757575);
            cursor: not-allowed;
            transform: none;
        }

        .button.primary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .button.success {
            background: linear-gradient(45deg, #4CAF50, #388E3C);
        }

        .button.warning {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }

        .button.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .passport-selector select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(5px);
            margin-bottom: 15px;
        }

        .passport-selector select option {
            background: #4a5568;
            color: white;
        }

        .passport-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
        }

        .passport-info h4 {
            margin-bottom: 10px;
            color: #ffd93d;
        }

        .passport-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .progress-section {
            grid-column: 1 / -1;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background: rgba(33, 150, 243, 0.3);
            border-left: 4px solid #2196F3;
        }

        .progress-step.completed {
            background: rgba(76, 175, 80, 0.3);
            border-left: 4px solid #4CAF50;
        }

        .progress-step.failed {
            background: rgba(244, 67, 54, 0.3);
            border-left: 4px solid #f44336;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            color: white;
        }

        .step-icon.completed {
            background: #4CAF50;
        }

        .step-icon.failed {
            background: #f44336;
        }

        .step-text {
            color: white;
            font-weight: 500;
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.info { color: #2196F3; }
        .log-entry.success { color: #4CAF50; }
        .log-entry.warning { color: #FF9800; }
        .log-entry.error { color: #f44336; }

        .wallet-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            word-break: break-all;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Comprehensive Passport Verification Test</h1>
            <p>End-to-end testing with realistic dummy passports - Enhanced Demo Version</p>
            <div id="progressIndicator" style="
                background: rgba(255, 255, 255, 0.1);
                padding: 10px 20px;
                border-radius: 10px;
                margin-top: 15px;
                text-align: center;
                font-weight: bold;
                display: none;
            ">
                <span id="currentStepText">Ready to start...</span>
            </div>
        </div>

        <div class="main-grid">
            <!-- Wallet Connection Panel -->
            <div class="panel">
                <h2>
                    <span class="status-indicator" id="walletStatus"></span>
                    üëõ Wallet Connection
                </h2>
                <button class="button primary" id="connectWalletBtn">Connect MetaMask</button>
                <div class="wallet-info hidden" id="walletInfo">
                    <strong>Connected:</strong>
                    <div id="walletAddress"></div>
                </div>
            </div>

            <!-- Passport Selection Panel -->
            <div class="panel">
                <h2>üìÑ Test Passport Selection</h2>
                <div class="passport-selector">
                    <select id="passportSelector">
                        <option value="">Select a test passport...</option>
                    </select>
                </div>
                <div class="passport-info hidden" id="passportInfo">
                    <h4>Selected Passport:</h4>
                    <div id="passportDetails"></div>
                </div>
            </div>

            <!-- Test Controls Panel -->
            <div class="panel">
                <h2>üéõÔ∏è Test Controls</h2>
                <button class="button success" id="startTestBtn" disabled>üöÄ Start Full Test</button>
                <button class="button warning" id="scanOnlyBtn" disabled>üì± Scan Only</button>
                <button class="button" id="checkStatusBtn" disabled>üîç Check Status</button>
                <button class="button danger" id="clearDataBtn" disabled>üßπ Clear Test Data</button>
            </div>

            <!-- Quick Actions Panel -->
            <div class="panel">
                <h2>‚ö° Quick Actions</h2>
                <button class="button" id="switchPassportBtn" disabled>üîÑ Switch Passport</button>
                <button class="button" id="viewStoredBtn" disabled>üìÇ View Stored Data</button>
                <button class="button" id="exportResultsBtn" disabled>üì§ Export Results</button>
                <button class="button" id="resetAllBtn">üîÑ Reset All</button>
            </div>

            <!-- Progress Tracking -->
            <div class="panel progress-section">
                <h2>üìä Test Progress</h2>
                <div class="progress-container">
                    <div class="progress-step" id="step1">
                        <div class="step-icon">1</div>
                        <div class="step-text">Wallet Connection</div>
                    </div>
                    <div class="progress-step" id="step2">
                        <div class="step-icon">2</div>
                        <div class="step-text">Passport Selection</div>
                    </div>
                    <div class="progress-step" id="step3">
                        <div class="step-icon">3</div>
                        <div class="step-text">NFC Scanning Simulation</div>
                    </div>
                    <div class="progress-step" id="step4">
                        <div class="step-icon">4</div>
                        <div class="step-text">TEE Verification</div>
                    </div>
                    <div class="progress-step" id="step5">
                        <div class="step-icon">5</div>
                        <div class="step-text">Identity Hash Generation</div>
                    </div>
                    <div class="progress-step" id="step6">
                        <div class="step-icon">6</div>
                        <div class="step-text">Blockchain Transaction</div>
                    </div>
                    <div class="progress-step" id="step7">
                        <div class="step-icon">7</div>
                        <div class="step-text">Off-chain Data Storage</div>
                    </div>
                    <div class="progress-step" id="step8">
                        <div class="step-icon">8</div>
                        <div class="step-text">Test Completion</div>
                    </div>
                </div>
            </div>

            <!-- Real-time Logs -->
            <div class="panel">
                <h2>üìù Real-time Logs</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry info">üöÄ Comprehensive test interface initialized (Fixed)</div>
                    <div class="log-entry info">üìã Ready for passport verification testing</div>
                </div>
            </div>

            <!-- On-Chain Status Panel -->
            <div id="onChainStatus" class="panel" style="display:none; margin-top:20px; color:white; background:rgba(76,175,80,0.2);">
                <h2>üîó On-Chain Verification</h2>
                <div id="onChainStatusContent">Checking on-chain status...</div>
            </div>
        </div>
    </div>

    <script src="ethers.umd.min.js"></script>
    <script>
        // All embedded - no external dependencies or module imports
        
        // Mock passport data (embedded) - Enhanced for hackathon demo
        const mockPassportData = [
            {
                "id": "test-passport-001",
                "name": "USA Passport - John Smith",
                "personalInfo": {
                    "fullName": "JOHN MICHAEL SMITH",
                    "dateOfBirth": "1985-06-15",
                    "placeOfBirth": "NEW YORK, USA",
                    "nationality": "AMERICAN",
                    "sex": "M"
                },
                "documentInfo": {
                    "documentType": "P",
                    "issuingCountry": "USA",
                    "documentNumber": "P123456789",
                    "issueDate": "2020-06-15",
                    "expiryDate": "2030-06-15",
                    "issuingAuthority": "U.S. DEPARTMENT OF STATE"
                },
                "securityInfo": {
                    "hasNFC": true,
                    "hasRFID": true,
                    "biometricData": "Available",
                    "digitalSignature": "RSA-2048"
                }
            },
            {
                "id": "test-passport-002", 
                "name": "UK Passport - Emma Johnson",
                "personalInfo": {
                    "fullName": "EMMA ANNE JOHNSON",
                    "dateOfBirth": "1990-03-22",
                    "placeOfBirth": "LONDON, UK",
                    "nationality": "BRITISH",
                    "sex": "F"
                },
                "documentInfo": {
                    "documentType": "P",
                    "issuingCountry": "GBR",
                    "documentNumber": "P987654321",
                    "issueDate": "2019-03-22",
                    "expiryDate": "2029-03-22",
                    "issuingAuthority": "HM PASSPORT OFFICE"
                },
                "securityInfo": {
                    "hasNFC": true,
                    "hasRFID": true,
                    "biometricData": "Available",
                    "digitalSignature": "ECDSA-P256"
                }
            },
            {
                "id": "test-passport-003",
                "name": "German Passport - Hans Mueller",
                "personalInfo": {
                    "fullName": "HANS FREDERICK MUELLER",
                    "dateOfBirth": "1982-11-08",
                    "placeOfBirth": "BERLIN, GERMANY",
                    "nationality": "GERMAN",
                    "sex": "M"
                },
                "documentInfo": {
                    "documentType": "P",
                    "issuingCountry": "DEU",
                    "documentNumber": "P456789123",
                    "issueDate": "2021-11-08",
                    "expiryDate": "2031-11-08",
                    "issuingAuthority": "BUNDESDRUCKEREI GMBH"
                },
                "securityInfo": {
                    "hasNFC": true,
                    "hasRFID": true,
                    "biometricData": "Available",
                    "digitalSignature": "RSA-4096"
                }
            },
            {
                "id": "test-passport-004",
                "name": "Canadian Passport - Marie Dubois",
                "personalInfo": {
                    "fullName": "MARIE CLAIRE DUBOIS",
                    "dateOfBirth": "1988-07-14",
                    "placeOfBirth": "MONTREAL, CANADA",
                    "nationality": "CANADIAN",
                    "sex": "F"
                },
                "documentInfo": {
                    "documentType": "P",
                    "issuingCountry": "CAN",
                    "documentNumber": "PC234567890",
                    "issueDate": "2022-07-14",
                    "expiryDate": "2032-07-14",
                    "issuingAuthority": "PASSPORT CANADA"
                },
                "securityInfo": {
                    "hasNFC": true,
                    "hasRFID": true,
                    "biometricData": "Available",
                    "digitalSignature": "ECDSA-P384"
                }
            },
            {
                "id": "test-passport-005",
                "name": "Japanese Passport - Yuki Tanaka",
                "personalInfo": {
                    "fullName": "YUKI TANAKA",
                    "dateOfBirth": "1992-04-03",
                    "placeOfBirth": "TOKYO, JAPAN",
                    "nationality": "JAPANESE",
                    "sex": "F"
                },
                "documentInfo": {
                    "documentType": "P",
                    "issuingCountry": "JPN",
                    "documentNumber": "PJ345678901",
                    "issueDate": "2023-04-03",
                    "expiryDate": "2033-04-03",
                    "issuingAuthority": "MINISTRY OF FOREIGN AFFAIRS"
                },
                "securityInfo": {
                    "hasNFC": true,
                    "hasRFID": true,
                    "biometricData": "Available",
                    "digitalSignature": "RSA-2048"
                }
            }
        ];

        // Global state
        class ComprehensiveTestInterface {
            constructor() {
                this.isWalletConnected = false;
                this.selectedPassport = null;
                this.testResults = null;
                this.currentStep = 0;
                this.walletAddress = null;
                
                this.initializeInterface();
                this.setupEventListeners();
                this.initializeMockServices();
            }

            initializeInterface() {
                this.logContainer = document.getElementById('logContainer');
                this.walletStatus = document.getElementById('walletStatus');
                this.connectWalletBtn = document.getElementById('connectWalletBtn');
                this.walletInfo = document.getElementById('walletInfo');
                this.walletAddressElement = document.getElementById('walletAddress');
                this.passportSelector = document.getElementById('passportSelector');
                this.passportInfo = document.getElementById('passportInfo');
                this.passportDetails = document.getElementById('passportDetails');
                this.startTestBtn = document.getElementById('startTestBtn');
                this.scanOnlyBtn = document.getElementById('scanOnlyBtn');
                this.checkStatusBtn = document.getElementById('checkStatusBtn');
                this.clearDataBtn = document.getElementById('clearDataBtn');
            }

            setupEventListeners() {
                this.connectWalletBtn.addEventListener('click', () => this.connectWallet());
                this.passportSelector.addEventListener('change', (e) => this.selectPassport(e.target.value));
                this.startTestBtn.addEventListener('click', () => this.startFullTest());
                this.scanOnlyBtn.addEventListener('click', () => this.scanOnly());
                this.checkStatusBtn.addEventListener('click', () => this.checkStatus());
                this.clearDataBtn.addEventListener('click', () => this.clearTestData());
                
                // Quick actions
                document.getElementById('switchPassportBtn').addEventListener('click', () => this.switchPassport());
                document.getElementById('viewStoredBtn').addEventListener('click', () => this.viewStoredData());
                document.getElementById('exportResultsBtn').addEventListener('click', () => this.exportResults());
                document.getElementById('resetAllBtn').addEventListener('click', () => this.resetAll());
            }

            async initializeMockServices() {
                try {
                    this.log('üîÑ Initializing mock services...', 'info');
                    this.loadTestPassports();
                    this.log('‚úÖ Mock services initialized successfully', 'success');
                } catch (error) {
                    this.log(`‚ùå Failed to initialize mock services: ${error.message}`, 'error');
                }
            }

            loadTestPassports() {
                mockPassportData.forEach(passport => {
                    const option = document.createElement('option');
                    option.value = passport.id;
                    option.textContent = `${passport.name} - ${passport.personalInfo.fullName} (${passport.documentInfo.issuingCountry})`;
                    this.passportSelector.appendChild(option);
                });

                this.log('‚úÖ Loaded test passports: ' + mockPassportData.length + ' available', 'success');
            }

            async connectWallet() {
                try {
                    this.log('üîÑ Connecting to MetaMask wallet...', 'info');
                    this.connectWalletBtn.disabled = true;
                    this.connectWalletBtn.innerHTML = '<span class="loading"></span> Connecting...';

                    // Check if MetaMask is available
                    if (typeof window.ethereum === 'undefined') {
                        throw new Error('MetaMask not detected! Please install MetaMask extension.');
                    }

                    this.log('ü¶ä MetaMask detected', 'success');

                    // Request account access
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });

                    if (accounts.length === 0) {
                        throw new Error('No accounts available');
                    }

                    this.walletAddress = accounts[0];
                    this.isWalletConnected = true;

                    // Check network
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    const chainIdDecimal = parseInt(chainId, 16);
                    
                    this.log(`üåê Connected to Chain ID: ${chainIdDecimal}`, 'info');
                    
                    if (chainIdDecimal === 31337) {
                        this.log('‚úÖ Correct network: Hardhat Local (31337)', 'success');
                    } else {
                        this.log(`‚ö†Ô∏è Warning: Expected Chain ID 31337, got ${chainIdDecimal}`, 'warning');
                    }

                    // Update UI
                    this.walletStatus.classList.add('connected');
                    this.walletAddressElement.textContent = this.walletAddress;
                    this.walletInfo.classList.remove('hidden');
                    this.connectWalletBtn.textContent = '‚úÖ Wallet Connected';
                    this.connectWalletBtn.disabled = true;
                    
                    this.updateStepStatus(1, 'completed');
                    this.enableControls();
                    
                    this.log(`‚úÖ Wallet connected successfully: ${this.walletAddress}`, 'success');

                } catch (error) {
                    this.log(`‚ùå Wallet connection failed: ${error.message}`, 'error');
                    this.connectWalletBtn.disabled = false;
                    this.connectWalletBtn.textContent = 'Connect MetaMask';
                    
                    if (error.code === 4001) {
                        this.log('üí° User rejected the connection request', 'warning');
                    }
                }
            }

            selectPassport(passportId) {
                if (!passportId) {
                    this.selectedPassport = null;
                    this.passportInfo.classList.add('hidden');
                    this.updateStepStatus(2, 'pending');
                    return;
                }

                this.selectedPassport = mockPassportData.find(p => p.id === passportId);
                if (this.selectedPassport) {
                    this.displayPassportInfo(this.selectedPassport);
                    this.updateStepStatus(2, 'completed');
                    this.log(`üìã Selected passport: ${this.selectedPassport.name}`, 'info');
                    
                    if (this.isWalletConnected) {
                        this.startTestBtn.disabled = false;
                        this.scanOnlyBtn.disabled = false;
                    }
                } else {
                    this.log('‚ùå Failed to select passport', 'error');
                }
            }

            displayPassportInfo(passport) {
                this.passportDetails.innerHTML = `
                    <div class="passport-detail"><span>Name:</span><span>${passport.personalInfo.fullName}</span></div>
                    <div class="passport-detail"><span>Document:</span><span>${passport.documentInfo.documentNumber}</span></div>
                    <div class="passport-detail"><span>Country:</span><span>${passport.documentInfo.issuingCountry}</span></div>
                    <div class="passport-detail"><span>Birth:</span><span>${passport.personalInfo.dateOfBirth}</span></div>
                    <div class="passport-detail"><span>Expires:</span><span>${passport.documentInfo.expiryDate}</span></div>
                    <div class="passport-detail"><span>Authority:</span><span>${passport.documentInfo.issuingAuthority}</span></div>
                    <div class="passport-detail"><span>NFC:</span><span>‚úÖ ${passport.securityInfo.hasNFC ? 'Available' : 'Not Available'}</span></div>
                    <div class="passport-detail"><span>Signature:</span><span>${passport.securityInfo.digitalSignature}</span></div>
                `;
                this.passportInfo.classList.remove('hidden');
            }

            async startFullTest() {
                if (!this.isWalletConnected || !this.selectedPassport) {
                    this.log('‚ùå Wallet and passport selection required', 'error');
                    return;
                }

                try {
                    this.log('üöÄ Starting comprehensive passport verification test...', 'info');
                    this.disableAllButtons();
                    this.clearPreviousResults();

                    // Step 3: NFC Scanning (Enhanced Realism)
                    this.updateStepStatus(3, 'active');
                    this.log('üì± Step 3: Starting enhanced NFC passport scanning...', 'info');
                    this.log('üîç Detecting NFC field...', 'info');
                    await this.delay(800);
                    
                    this.log('üì° NFC field detected - establishing connection...', 'info');
                    await this.delay(600);
                    
                    this.log('üîê Performing Basic Access Control (BAC)...', 'info');
                    await this.delay(900);
                    
                    this.log('üìÑ Reading Data Group 1 (MRZ)...', 'info');
                    await this.delay(500);
                    
                    this.log('üñºÔ∏è Reading Data Group 2 (Facial Image)...', 'info');
                    await this.delay(700);
                    
                    this.log('üîë Reading Data Group 15 (Active Authentication)...', 'info');
                    await this.delay(600);
                    
                    this.log('‚úÖ NFC scan completed - Document verified!', 'success');
                    const passportData = this.selectedPassport;
                    this.updateStepStatus(3, 'completed');
                    this.log(`üìã Document: ${passportData.documentInfo.documentNumber}`, 'success');
                    this.log(`üõÇ Authority: ${passportData.documentInfo.issuingAuthority}`, 'success');

                    // Step 4: TEE Verification (Enhanced Realism)
                    this.updateStepStatus(4, 'active');
                    this.log('üîí Step 4: Starting TEE (Trusted Execution Environment) verification...', 'info');
                    this.log('‚ö° Initializing secure enclave...', 'info');
                    await this.delay(600);
                    
                    this.log('üõ°Ô∏è Loading cryptographic keys in TEE...', 'info');
                    await this.delay(500);
                    
                    this.log('üìä Validating passport structure and format...', 'info');
                    await this.delay(700);
                    
                    this.log('üîê Verifying digital signatures against ICAO PKI...', 'info');
                    await this.delay(800);
                    
                    this.log('üèõÔ∏è Checking certificate chain validity...', 'info');
                    await this.delay(600);
                    
                    this.log('üìÖ Validating document expiry and issue dates...', 'info');
                    await this.delay(500);
                    
                    this.log('üîè Generating TEE attestation signature...', 'info');
                    await this.delay(700);
                    
                    this.updateStepStatus(4, 'completed');
                    this.log('‚úÖ TEE verification completed - Passport authenticated!', 'success');
                    this.log(`üîë Signature Algorithm: ${passportData.securityInfo.digitalSignature}`, 'success');
                    this.log('üõ°Ô∏è TEE attestation: VALID', 'success');

                    // Step 5: Identity Hash Generation
                    this.updateStepStatus(5, 'active');
                    this.log('üî¢ Step 5: Generating identity hash...', 'info');
                    await this.delay(1000);
                    const identityHash = this.generateMockHash(passportData);
                    this.updateStepStatus(5, 'completed');
                    this.log(`‚úÖ Step 5: Identity hash generated: ${identityHash.substring(0, 16)}...`, 'success');

                    // Step 6: Blockchain Transaction (Optional)
                    this.updateStepStatus(6, 'active');
                    this.log('‚õìÔ∏è Step 6: Starting blockchain transaction...', 'info');
                    this.log('üí° Click "Confirm" in MetaMask to sign, or "Cancel" to skip', 'info');
                    
                    const signature = await this.signMessage(`Passport verification test`);
                    if (signature) {
                        this.updateStepStatus(6, 'completed');
                        this.log('‚úÖ Step 6: Blockchain transaction completed', 'success');
                        this.log(`üìù Signature: ${signature.substring(0, 20)}...`, 'info');
                        // Show on-chain status
                        await this.showOnChainStatus(this.walletAddress, identityHash);
                    } else {
                        this.updateStepStatus(6, 'completed');
                        this.log('‚ö†Ô∏è Step 6: Blockchain transaction skipped (user declined)', 'warning');
                        this.log('üí° Test can continue without signature', 'info');
                    }

                    // Step 7: Off-chain Data Storage
                    this.updateStepStatus(7, 'active');
                    this.log('üíæ Step 7: Storing off-chain data...', 'info');
                    await this.delay(1000);
                    this.updateStepStatus(7, 'completed');
                    this.log('‚úÖ Step 7: Off-chain data stored successfully', 'success');

                    // Step 8: Test Completion & Summary
                    this.updateStepStatus(8, 'completed');
                    this.log('üéâ Step 8: Full verification test completed successfully!', 'success');
                    
                    // Display comprehensive summary
                    this.log('', 'info'); // Empty line for spacing
                    this.log('üìä === VERIFICATION SUMMARY ===', 'success');
                    this.log(`üë§ Identity: ${passportData.personalInfo.fullName}`, 'success');
                    this.log(`üõÇ Document: ${passportData.documentInfo.documentNumber}`, 'success');
                    this.log(`üåç Country: ${passportData.documentInfo.issuingCountry}`, 'success');
                    this.log(`üèõÔ∏è Authority: ${passportData.documentInfo.issuingAuthority}`, 'success');
                    this.log(`üîë Hash: ${identityHash.substring(0, 20)}...`, 'success');
                    this.log(`üìù Signature: ${signature ? signature.substring(0, 20) + '...' : 'Skipped'}`, 'success');
                    this.log(`‚è∞ Verified: ${new Date().toLocaleString()}`, 'success');
                    this.log(`üõ°Ô∏è Security Level: HIGH (TEE + Blockchain)`, 'success');
                    this.log('‚úÖ STATUS: IDENTITY VERIFIED', 'success');
                    this.log('', 'info'); // Empty line for spacing
                    
                    this.testResults = {
                        passport: passportData,
                        identityHash,
                        signature,
                        timestamp: new Date().toISOString(),
                        status: 'VERIFIED',
                        securityLevel: 'HIGH'
                    };

                    // Show success notification
                    this.showSuccessNotification(passportData);

                } catch (error) {
                    this.log(`‚ùå Test failed: ${error.message}`, 'error');
                    this.updateStepStatus(this.currentStep, 'failed');
                } finally {
                    this.enableControls();
                }
            }

            async scanOnly() {
                if (!this.selectedPassport) {
                    this.log('‚ùå Please select a test passport first', 'error');
                    return;
                }

                try {
                    this.log('üì± Starting passport scan only test...', 'info');
                    this.updateStepStatus(3, 'active');
                    
                    await this.delay(1500);
                    
                    this.updateStepStatus(3, 'completed');
                    this.log('‚úÖ Scan-only test completed', 'success');
                    this.log(`üìä Scanned data: ${JSON.stringify(this.selectedPassport.personalInfo, null, 2)}`, 'info');
                } catch (error) {
                    this.log(`‚ùå Scan failed: ${error.message}`, 'error');
                    this.updateStepStatus(3, 'failed');
                }
            }

            // Utility functions
            async delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            generateMockHash(passport) {
                const data = `${passport.personalInfo.fullName}${passport.documentInfo.documentNumber}${passport.personalInfo.dateOfBirth}`;
                return '0x' + Array.from(data).map(c => c.charCodeAt(0).toString(16)).join('').padEnd(64, '0');
            }

            async signMessage(message) {
                try {
                    if (!window.ethereum || !this.walletAddress) {
                        throw new Error('Wallet not connected');
                    }

                    // Use simple string message signing - MetaMask handles the encoding internally
                    const signature = await window.ethereum.request({
                        method: 'personal_sign',
                        params: [message, this.walletAddress]
                    });

                    return signature;
                } catch (error) {
                    if (error.code === 4001) {
                        this.log('üí° User rejected the signing request', 'warning');
                    } else {
                        this.log(`‚ùå Signing failed: ${error.message}`, 'error');
                    }
                    return null;
                }
            }

            updateStepStatus(stepNumber, status) {
                const step = document.getElementById(`step${stepNumber}`);
                const icon = step.querySelector('.step-icon');
                const progressIndicator = document.getElementById('progressIndicator');
                const currentStepText = document.getElementById('currentStepText');
                
                // Show progress indicator when test starts
                if (stepNumber >= 3) {
                    progressIndicator.style.display = 'block';
                }
                
                // Update progress text
                const stepNames = {
                    1: 'Connecting Wallet...',
                    2: 'Selecting Passport...',
                    3: 'Scanning Passport via NFC...',
                    4: 'Verifying in TEE...',
                    5: 'Generating Identity Hash...',
                    6: 'Blockchain Transaction...',
                    7: 'Storing Off-chain Data...',
                    8: 'Verification Complete! üéâ'
                };
                
                if (status === 'active') {
                    currentStepText.textContent = `Step ${stepNumber}/8: ${stepNames[stepNumber]}`;
                } else if (status === 'completed' && stepNumber === 8) {
                    currentStepText.textContent = stepNames[stepNumber];
                }
                
                // Remove all status classes
                step.classList.remove('active', 'completed', 'failed');
                icon.classList.remove('completed', 'failed');
                
                // Add new status
                if (status === 'active') {
                    step.classList.add('active');
                } else if (status === 'completed') {
                    step.classList.add('completed');
                    icon.classList.add('completed');
                    icon.textContent = '‚úì';
                } else if (status === 'failed') {
                    step.classList.add('failed');
                    icon.classList.add('failed');
                    icon.textContent = '‚úó';
                } else {
                    icon.textContent = stepNumber;
                }
                
                this.currentStep = stepNumber;
            }

            enableControls() {
                if (this.isWalletConnected && this.selectedPassport) {
                    this.startTestBtn.disabled = false;
                    this.scanOnlyBtn.disabled = false;
                }
                if (this.isWalletConnected) {
                    this.checkStatusBtn.disabled = false;
                    this.clearDataBtn.disabled = false;
                    document.getElementById('viewStoredBtn').disabled = false;
                }
                if (this.testResults) {
                    document.getElementById('exportResultsBtn').disabled = false;
                }
                document.getElementById('switchPassportBtn').disabled = false;
            }

            disableAllButtons() {
                this.startTestBtn.disabled = true;
                this.scanOnlyBtn.disabled = true;
                this.checkStatusBtn.disabled = true;
                this.clearDataBtn.disabled = true;
            }

            clearPreviousResults() {
                this.testResults = null;
                // Reset all steps except wallet connection and passport selection
                for (let i = 3; i <= 8; i++) {
                    this.updateStepStatus(i, 'pending');
                }
            }

            // Quick action methods
            switchPassport() {
                this.passportSelector.selectedIndex = 0;
                this.selectPassport('');
                this.log('üîÑ Passport selection cleared - please select a new passport', 'info');
            }

            viewStoredData() {
                this.checkStatus();
            }

            exportResults() {
                if (!this.testResults) {
                    this.log('‚ùå No test results to export', 'error');
                    return;
                }

                const exportData = {
                    exportedAt: new Date().toISOString(),
                    testResults: this.testResults,
                    walletAddress: this.walletAddress,
                    selectedPassport: this.selectedPassport
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `passport-test-results-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);

                this.log('üì§ Test results exported successfully', 'success');
            }

            checkStatus() {
                if (!this.walletAddress) {
                    this.log('‚ùå No wallet connected', 'error');
                    return;
                }

                if (this.testResults) {
                    this.log('‚úÖ Found stored test data', 'success');
                    this.log(`üìä Test info: Passport verified for ${this.testResults.passport.personalInfo.fullName}`, 'info');
                } else {
                    this.log('‚ÑπÔ∏è No stored test data found for this wallet', 'info');
                }
            }

            clearTestData() {
                if (!this.walletAddress) {
                    this.log('‚ùå No wallet connected', 'error');
                    return;
                }

                this.testResults = null;
                this.clearPreviousResults();
                this.log('üßπ Test data cleared successfully', 'success');
            }

            resetAll() {
                // Reset interface state
                this.isWalletConnected = false;
                this.selectedPassport = null;
                this.testResults = null;
                this.currentStep = 0;
                this.walletAddress = null;

                // Reset UI elements
                this.walletStatus.classList.remove('connected');
                this.walletInfo.classList.add('hidden');
                this.passportInfo.classList.add('hidden');
                this.connectWalletBtn.disabled = false;
                this.connectWalletBtn.textContent = 'Connect MetaMask';
                this.passportSelector.selectedIndex = 0;

                // Reset all steps
                for (let i = 1; i <= 8; i++) {
                    this.updateStepStatus(i, 'pending');
                }

                // Disable all buttons except reset
                this.disableAllButtons();
                document.getElementById('switchPassportBtn').disabled = true;
                document.getElementById('viewStoredBtn').disabled = true;
                document.getElementById('exportResultsBtn').disabled = true;

                // Clear logs except initial messages
                this.logContainer.innerHTML = `
                    <div class="log-entry info">üöÄ Comprehensive test interface reset</div>
                    <div class="log-entry info">üìã Ready for new passport verification testing</div>
                `;

                this.log('üîÑ Interface reset completed - ready for new test', 'success');
            }

            log(message, type = 'info') {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
                
                // Also log to console for debugging
                console.log(`[ComprehensiveTest] ${message}`);
            }

            showSuccessNotification(passport) {
                // Create success modal if it doesn't exist
                let modal = document.getElementById('successModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'successModal';
                    modal.innerHTML = `
                        <div style="
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.7);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 1000;
                        ">
                            <div style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                padding: 40px;
                                border-radius: 20px;
                                text-align: center;
                                color: white;
                                max-width: 500px;
                                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                            ">
                                <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                                <h2 style="margin-bottom: 15px; color: #fff;">Verification Complete!</h2>
                                <p style="margin-bottom: 20px; opacity: 0.9;">
                                    Identity successfully verified for<br>
                                    <strong>${passport.personalInfo.fullName}</strong>
                                </p>
                                <div style="
                                    background: rgba(255,255,255,0.1);
                                    padding: 15px;
                                    border-radius: 10px;
                                    margin-bottom: 20px;
                                    font-family: monospace;
                                    font-size: 0.9rem;
                                ">
                                    üõÇ ${passport.documentInfo.documentNumber}<br>
                                    üåç ${passport.documentInfo.issuingCountry}<br>
                                    üõ°Ô∏è TEE Verified ‚úÖ<br>
                                    ‚õìÔ∏è Blockchain Secured ‚úÖ
                                </div>
                                <button onclick="document.getElementById('successModal').remove()" style="
                                    background: rgba(255,255,255,0.2);
                                    border: 2px solid white;
                                    color: white;
                                    padding: 12px 30px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    font-weight: bold;
                                ">
                                    Continue
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Auto-remove after 10 seconds
                    setTimeout(() => {
                        if (modal && modal.parentNode) {
                            modal.remove();
                        }
                    }, 10000);
                }
            }

            async showOnChainStatus(address, identityHash) {
                try {
                    // Check if ethers is defined
                    if (typeof ethers === 'undefined') {
                        document.getElementById('onChainStatus').style.display = 'block';
                        document.getElementById('onChainStatusContent').innerHTML =
                            `<span style="color:#ff6b6b;">‚ùå Error: ethers is not defined.\\n` +
                            `typeof ethers: ${typeof ethers}.\\n` +
                            `Check if the ethers.js script is loaded and not blocked by browser extensions or Content Security Policy.\\n` +
                            `Try opening the browser console (F12) and type 'ethers' to see if it is available.</span>`;
                        return;
                    }

                    // Load contract info (adjust path if needed)
                    const response = await fetch('./contract-info.json');
                    const contractInfo = await response.json();
                    const contractABI = contractInfo.abi;
                    const contractAddress = contractInfo.address;

                    // Ethers v6: Use BrowserProvider and getSigner
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(contractAddress, contractABI, signer);

                    // Query the on-chain identity info
                    let identity;
                    try {
                        identity = await contract.identities(address);
                    } catch (contractError) {
                        // Handle case where contract call fails
                        document.getElementById('onChainStatus').style.display = 'block';
                        document.getElementById('onChainStatusContent').innerHTML =
                            `<span style="color:#ff6b6b;">‚ùå Failed to query contract: ${contractError.message}</span><br>
                             <small>Make sure Hardhat local network is running and the contract is deployed.</small>`;
                        return;
                    }

                    // Check if identity data exists (handle empty return)
                    const identityHashFromChain = identity[0];
                    const hasData = identityHashFromChain && identityHashFromChain !== '0x0000000000000000000000000000000000000000000000000000000000000000';
                    
                    document.getElementById('onChainStatus').style.display = 'block';
                    
                    if (hasData) {
                        // Compare the stored hash with the generated one
                        const isStored = identityHashFromChain.toLowerCase() === identityHash.toLowerCase();
                        
                        document.getElementById('onChainStatusContent').innerHTML = isStored
                            ? `<span style="color:#51cf66;">‚úÖ Public key (identity hash) is stored on-chain for this wallet!</span><br>
                               <strong>On-chain Hash:</strong> ${identityHashFromChain}<br>
                               <strong>Verified:</strong> ${identity[2] ? "‚úÖ" : "‚ùå"}<br>
                               <strong>Timestamp:</strong> ${new Date(identity[1] * 1000).toLocaleString()}<br>
                               <strong>Verifier:</strong> ${identity[3]}`
                            : `<span style="color:#ffd93d;">‚ö†Ô∏è Different identity hash stored on-chain for this wallet.</span><br>
                               <strong>Expected Hash:</strong> ${identityHash}<br>
                               <strong>On-chain Hash:</strong> ${identityHashFromChain}<br>
                               <strong>Verified:</strong> ${identity[2] ? "‚úÖ" : "‚ùå"}`;
                    } else {
                        // No data stored on-chain - show option to store it
                        document.getElementById('onChainStatusContent').innerHTML = 
                            `<span style="color:#ffd93d;">‚ö†Ô∏è No identity data stored on-chain for this wallet address.</span><br><br>
                             <strong>Expected Hash:</strong> ${identityHash}<br><br>
                             <button onclick="storeIdentityOnChain('${address}', '${identityHash}')" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: bold;
                             ">üîó Store Identity On-Chain</button>
                             <br><small style="opacity: 0.8;">Click to actually store the identity hash on the blockchain</small>`;
                    }
                } catch (err) {
                    document.getElementById('onChainStatus').style.display = 'block';
                    document.getElementById('onChainStatusContent').innerHTML =
                        `<span style="color:#ff6b6b;">‚ùå Error checking on-chain status: ${err.message}</span><br><br>
                         <strong>Debug Info:</strong><br>
                         <small>Error: ${err.message}<br>
                         Address: ${address}<br>
                         Network: Make sure you're connected to Hardhat Local (chainId: 31337)</small>`;
                }
            }

            // Add this function to actually store identity on-chain
            async storeIdentityOnChain(address, identityHash) {
                try {
                    this.log('üîó Storing identity on blockchain...', 'info');
                    
                    // Load contract info
                    const response = await fetch('./contract-info.json');
                    const contractInfo = await response.json();
                    const contractABI = contractInfo.abi;
                    const contractAddress = contractInfo.address;

                    // Get provider and signer
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(contractAddress, contractABI, signer);

                    // Create a mock signature for the contract call
                    const message = `Verification for ${identityHash}`;
                    const signature = await this.signMessage(message);
                    
                    if (!signature) {
                        this.log('‚ùå Signature required to store on-chain', 'error');
                        return;
                    }

                    // Call verifyIdentity on the contract
                    const tx = await contract.verifyIdentity(address, identityHash, signature);
                    this.log(`üìù Transaction submitted: ${tx.hash}`, 'info');
                    
                    // Wait for confirmation
                    const receipt = await tx.wait();
                    this.log(`‚úÖ Transaction confirmed in block ${receipt.blockNumber}`, 'success');
                    
                    // Refresh the on-chain status
                    await this.showOnChainStatus(address, identityHash);
                    
                } catch (error) {
                    this.log(`‚ùå Failed to store on-chain: ${error.message}`, 'error');
                    if (error.message.includes('Invalid signature')) {
                        this.log('üí° Note: This is expected as we are using mock TEE verification', 'warning');
                    }
                }
            }
        }

        // Initialize the test interface when page loads
        let comprehensiveTestInstance;
        document.addEventListener('DOMContentLoaded', () => {
            comprehensiveTestInstance = new ComprehensiveTestInterface();
        });

        // Global function for button onclick
        async function storeIdentityOnChain(address, identityHash) {
            if (comprehensiveTestInstance) {
                await comprehensiveTestInstance.storeIdentityOnChain(address, identityHash);
            }
        }
    </script>
</body>
</html> 